name: build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  GCC_VERSION: '15'
  LLVM_VERSION: '20'

jobs:
  build-linux:
    runs-on: ubuntu-latest

    container:
      image: ubuntu:latest

    strategy:
      matrix:
        config: [Debug, Release]
        compiler: [g++, clang++]
        sanitizer: ['', -fsanitize=address, -fsanitize=undefined]
        shared: ['OFF', 'ON']

      fail-fast: false

    defaults:
      run:
        shell: bash

    env:
      DEBIAN_FRONTEND: noninteractive
      UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1

    steps:
      - run: |
          apt-get update
          apt-get upgrade -y
          apt-get install -y build-essential curl file git procps

      - run: |
          NONINTERACTIVE=1 bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo /home/linuxbrew/.linuxbrew/bin >> "$GITHUB_PATH"

      - run: |
          brew install binutils gcc@${{ env.GCC_VERSION }}
          echo /home/linuxbrew/.linuxbrew/opt/binutils/bin >> "$GITHUB_PATH"
          ln -s /home/linuxbrew/.linuxbrew/bin/gcc-${{ env.GCC_VERSION }} /home/linuxbrew/.linuxbrew/bin/gcc
          ln -s /home/linuxbrew/.linuxbrew/bin/g++-${{ env.GCC_VERSION }} /home/linuxbrew/.linuxbrew/bin/g++

      - if: ${{ matrix.compiler == 'clang++' }}
        run: |
          brew install llvm@${{ env.LLVM_VERSION }}
          echo /home/linuxbrew/.linuxbrew/opt/llvm@${{ env.LLVM_VERSION }}/bin >> "$GITHUB_PATH"

          mkdir -p ~/.config/clang

          cat > ~/.config/clang/clang.cfg <<EOF
          -isystem /home/linuxbrew/.linuxbrew/include
          -L/home/linuxbrew/.linuxbrew/lib
          -Wl,-rpath,/home/linuxbrew/.linuxbrew/lib
          -Wl,--enable-new-dtags
          EOF

          cat > ~/.config/clang/clang++.cfg <<EOF
          -nostdinc++
          -isystem /home/linuxbrew/.linuxbrew/include/c++/${{ env.GCC_VERSION }}
          -isystem /home/linuxbrew/.linuxbrew/include/c++/${{ env.GCC_VERSION }}/x86_64-pc-linux-gnu
          -isystem /home/linuxbrew/.linuxbrew/include/c++/${{ env.GCC_VERSION }}/backward
          -isystem /home/linuxbrew/.linuxbrew/include
          -L/home/linuxbrew/.linuxbrew/lib/gcc/${{ env.GCC_VERSION }}
          -L/home/linuxbrew/.linuxbrew/lib
          -Wl,-rpath,/home/linuxbrew/.linuxbrew/lib/gcc/${{ env.GCC_VERSION }}
          -Wl,-rpath,/home/linuxbrew/.linuxbrew/lib
          -Wl,--enable-new-dtags
          EOF

      - run: brew install cmake ninja

      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - run: chown -R $(whoami):$(whoami) .

      - run: |
          cmake \
            -S . \
            -B build \
            -DCMAKE_BUILD_TYPE="${{ matrix.config }}" \
            -DCMAKE_CXX_COMPILER="${{ matrix.compiler }}" \
            -DCMAKE_CXX_FLAGS="${{ matrix.sanitizer }}" \
            -DCMAKE_EXE_LINKER_FLAGS="${{ matrix.sanitizer }}" \
            -DCMAKE_SHARED_LINKER_FLAGS="${{ matrix.sanitizer }}" \
            -DCMAKE_MODULE_LINKER_FLAGS="${{ matrix.sanitizer }}" \
            -DBUILD_SHARED_LIBS="${{ matrix.shared }}" \
            -DMINI_LLVM_TESTS=ON \
            -G Ninja

      - run: cmake --build build

      - run: ctest --test-dir build

      - run: |
          apt-get install -y gcc-riscv64-linux-gnu qemu-user
          mkdir -p /usr/gnemul
          ln -s /usr/riscv64-linux-gnu /usr/gnemul/qemu-riscv64

      - working-directory: ./tests/mini-llc
        run: |
          export MINI_LLC_COMMAND=../../build/bin/mini-llc
          export LINKER_COMMAND=riscv64-linux-gnu-gcc
          export EMULATOR_COMMAND=qemu-riscv64

          ./test_all.sh --target=riscv64

  build-windows:
    runs-on: windows-2025

    strategy:
      matrix:
        config: [Debug, Release]
        shared: ['ON', 'OFF']

      fail-fast: false

    defaults:
      run:
        shell: cmd

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - run: |
          cmake ^
            -S . ^
            -B ${{ github.workspace }}/build ^
            -DBUILD_SHARED_LIBS=${{ matrix.shared }} ^
            -DMINI_LLVM_TESTS=ON ^
            -G "Visual Studio 17 2022"

      - run: cmake --build build --config ${{ matrix.config }}

      - run: ctest --test-dir build --build-config ${{ matrix.config }}
