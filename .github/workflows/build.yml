name: build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

defaults:
  run:
    shell: bash

env:
  GCC_VERSION: '15'
  LLVM_VERSION: '20'

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ubuntu:latest

    strategy:
      matrix:
        build-type: [Debug, Release]
        toolchain: [GCC, LLVM]
        sanitizer: ['', ASan, UBSan]
        build-shared-libs: [false, true]

      fail-fast: false

    env:
      DEBIAN_FRONTEND: noninteractive
      UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1

    steps:
      - run: |
          apt-get update
          apt-get upgrade -y
          apt-get install -y build-essential curl file git procps

      - run: |
          NONINTERACTIVE=1 bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo /home/linuxbrew/.linuxbrew/bin >> "$GITHUB_PATH"

      - run: |
          brew install binutils gcc@${{ env.GCC_VERSION }}
          echo /home/linuxbrew/.linuxbrew/opt/binutils/bin >> "$GITHUB_PATH"

      - if: ${{ matrix.toolchain == 'LLVM' }}
        run: |
          brew install llvm@${{ env.LLVM_VERSION }}
          echo /home/linuxbrew/.linuxbrew/opt/llvm@${{ env.LLVM_VERSION }}/bin >> "$GITHUB_PATH"

          mkdir -p ~/.config/clang

          cat > ~/.config/clang/clang.cfg <<EOF
          -isystem /home/linuxbrew/.linuxbrew/include
          -L/home/linuxbrew/.linuxbrew/lib
          -Wl,-rpath,/home/linuxbrew/.linuxbrew/lib
          -Wl,--enable-new-dtags
          EOF

          cat > ~/.config/clang/clang++.cfg <<EOF
          -nostdinc++
          -isystem /home/linuxbrew/.linuxbrew/include/c++/${{ env.GCC_VERSION }}
          -isystem /home/linuxbrew/.linuxbrew/include/c++/${{ env.GCC_VERSION }}/x86_64-pc-linux-gnu
          -isystem /home/linuxbrew/.linuxbrew/include/c++/${{ env.GCC_VERSION }}/backward
          -isystem /home/linuxbrew/.linuxbrew/include
          -L/home/linuxbrew/.linuxbrew/lib/gcc/${{ env.GCC_VERSION }}
          -L/home/linuxbrew/.linuxbrew/lib
          -Wl,-rpath,/home/linuxbrew/.linuxbrew/lib/gcc/${{ env.GCC_VERSION }}
          -Wl,-rpath,/home/linuxbrew/.linuxbrew/lib
          -Wl,--enable-new-dtags
          EOF

      - run: brew install cmake ninja

      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - run: chown -R $(whoami):$(whoami) .

      - run: |
          case "${{ matrix.build-type }}" in
            Debug)
              BUILD_TYPE="Debug"
              ;;
            Release)
              BUILD_TYPE="Release"
              ;;
          esac

          case "${{ matrix.toolchain }}" in
            GCC)
              CXX_COMPILER=g++-${{ env.GCC_VERSION }}
              ;;
            LLVM)
              CXX_COMPILER=clang++
              ;;
          esac

          case "${{ matrix.sanitizer }}" in
            "")
              SANITIZER_FLAG=""
              ;;
            ASan)
              SANITIZER_FLAG="-fsanitize=address"
              ;;
            UBSan)
              SANITIZER_FLAG="-fsanitize=undefined"
              ;;
          esac

          case ${{ matrix.build-shared-libs }} in
            true)
              BUILD_SHARED_LIBS="ON"
              ;;
            false)
              BUILD_SHARED_LIBS="OFF"
              ;;
          esac

          cmake \
            -S . \
            -B build \
            -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_CXX_COMPILER="$CXX_COMPILER" \
            -DCMAKE_CXX_FLAGS="$SANITIZER_FLAG" \
            -DCMAKE_EXE_LINKER_FLAGS="$SANITIZER_FLAG" \
            -DCMAKE_SHARED_LINKER_FLAGS="$SANITIZER_FLAG" \
            -DCMAKE_MODULE_LINKER_FLAGS="$SANITIZER_FLAG" \
            -DBUILD_SHARED_LIBS="$BUILD_SHARED_LIBS" \
            -DMINI_LLVM_TESTS=ON \
            -G Ninja

      - run: cmake --build build

      - run: ctest --test-dir build

      - run: |
          apt-get install -y gcc-riscv64-linux-gnu qemu-user
          mkdir -p /usr/gnemul
          ln -s /usr/riscv64-linux-gnu /usr/gnemul/qemu-riscv64

      - working-directory: ./tests/mini-llc
        run: |
          export MINI_LLC_COMMAND=../../build/bin/mini-llc
          export LINKER_COMMAND=riscv64-linux-gnu-gcc
          export EMULATOR_COMMAND=qemu-riscv64

          ./test_all.sh --target=riscv64
